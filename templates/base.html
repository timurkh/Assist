<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Tactica</title>

<!-- Firebase init -->
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
<script src="static/firebase.js?rndstr=<%= getRandomStr() %>"></script>

<script>
	const postSignOut = function() {
		// POST to session login endpoint.
		$.ajax({
			type:'POST',
			url: '/sessionLogout',
			contentType: 'application/x-www-form-urlencoded'
		})
		.then(function() {
			// Redirect to profile on success.
			window.location.assign('/login');
		}, function(error) {
			// Refresh page on error.
			// In all cases, client side state should be lost due to in-memory
			// persistence.
			console.log(error);
		});
	}

	// Initialize Firebase
	firebase.initializeApp(firebaseConfig);
	firebase.analytics();

</script>

<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</head>

<body>
	<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
		<a class="navbar-brand" href="/home">Tactica</a>

{{if .Session.EmailVerified}}
		<ul class="navbar-nav">
			<li><a class="nav-link" href="/squads">Squads</a></li>
			<li><a class="nav-link" href="/events">Events</a></li>
			<li><a class="nav-link" href="/places">Places</a></li>
		</ul>
		<a class="navbar-brand ml-auto" href="userinfo" id="sign-in-status">{{.Session.DisplayName}} ({{.Session.Email}})</a>
{{end}}			
		<ul class="navbar-nav">
			<li><a class="nav-link" href="#" onclick="postSignOut()">Sign out</a></li>
		</ul>

	</nav>

{{if .Session.EmailVerified}}
	<div class="container-fluid">
	  {{template "body" . }}
	</div>

{{else}}
	<script>
		firebase.auth().onAuthStateChanged(user => {
			if (user) {
				document.getElementById('btnSendVerEmail').disabled = false;
			}
		})

		const sendVerificationEmail = function() {
			user = firebase.auth().currentUser;
			user.sendEmailVerification().then(
				function() {
					// Show redirection notice.
					document.getElementById('verEmailSent').style.display = '';
					document.getElementById('sendVerEmail').style.display = 'none';
					document.getElementById('btnSendVerEmailDiv').style.display = 'none';
				}
			).catch(function(error) {
				console.log(error);
			});
		}
	</script>
	<div class="container">
		<div class="alert alert-primary mt-2" role="alert">
		<div class="row align-items-center">
			<div class="col text-center">
				<div id="sendVerEmail" class="row align-items-center">
					<div class="col">
						<i class="far fa-user" style="font-size:64px;color:red;"></i>
					</div>
					<div class="col-11">
						Hello, {{.Session.DisplayName}}. Your email {{.Session.Email}} is not verified yet. Click button below and you will recieve a verification link.
					</div>
				</div>
				<div class="row align-items-center" id="verEmailSent" style="display:none">
					<div class="col">
						<i class="far fa-user" style="font-size:64px;color:green"></i>
					</div>
					<div class="col-11">
						Verification email successfully sent. Check your mailbox and follow instructions.
					</div>
				</div>
				<div id="btnSendVerEmailDiv" class="row">
					<div class="col">
					<button id="btnSendVerEmail" type="button" class="btn btn-info" disabled="true" onclick="sendVerificationEmail()">Get verification email</button>
					</div>
				</div>
			</div>
		</div>
	</div>
{{end}}

</body>
</html>
