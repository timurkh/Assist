<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Tactica</title>

<!-- Firebase init -->
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
<script src="static/firebase.js?rndstr=<%= getRandomStr() %>"></script>

<script>
	const postSignOut = function() {
		// POST to session login endpoint.
		$.ajax({
			type:'POST',
			url: '/sessionLogout',
			contentType: 'application/x-www-form-urlencoded'
		})
		.then(function() {
			// Redirect to profile on success.
			window.location.assign('/login');
		}, function(error) {
			// Refresh page on error.
			// In all cases, client side state should be lost due to in-memory
			// persistence.
			console.log(error);
		});
	}

	// Initialize Firebase
	firebase.initializeApp(firebaseConfig);
	firebase.analytics();

</script>

<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</head>

<body>
	<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
		<a class="navbar-brand" href="#">Tactica</a>

{{if .Session.EmailVerified}}
		<ul class="navbar-nav">
			<li><a class="nav-link" href="/home">Home</a></li>
			<li><a class="nav-link" href="/users">Users</a></li>
			<li><a class="nav-link" href="/events">Events</a></li>
		</ul>
{{end}}			
		<a class="navbar-brand ml-auto" href="userinfo" id="sign-in-status">{{.Session.DisplayName}} ({{.Session.Email}})</a>
		<ul class="navbar-nav">
			<li><a class="nav-link" href="#" onclick="postSignOut()">Sign out</a></li>
		</ul>

	</nav>

{{if .Session.EmailVerified}}
	<div class="container-fluid">
	  {{template "body" .Data}}
	</div>

{{else}}
	<script>
		firebase.auth().onAuthStateChanged(user => {
			if (user) {
				console.log("now firebase thinks that we are logged in");
				document.getElementById('btnSendVerEmail').disabled = false;
			}
		})

		const sendVerificationEmail = function() {
			user = firebase.auth().currentUser;
			user.sendEmailVerification().then(
				function() {
					// Show redirection notice.
					document.getElementById('verEmailSent').style.visibility = 'visible';
					document.getElementById('sendVerEmail').style.visibility = 'hidden';
					// Disable button
					document.getElementById('btnSendVerEmail').style.visibility = 'hidden';
				}
			).catch(function(error) {
				console.log(error);
			});
		}
	</script>
	<div class="container">
		<div class="row h-25"> 
			<div class="col text-center">
				&nbsp;
			</div>
		</div>
		<div class="row align-items-center">
			<div class="col text-center">
				<div class="alert alert-primary" role="alert">
					<div id="sendVerEmail">
					Your email {{.Session.Email}} is not verified yet. Click button below and you will recieve a verification link.
					</div>
					<div id="verEmailSent" style="visibility:hidden">
						Verification email successfully sent. Check your mailbox and follow instructions.
					</div>
					<button id="btnSendVerEmail" type="button" class="btn btn-info" disabled="true" onclick="sendVerificationEmail()">Get verification email</button>
				</div>
			</div>
		</div>
	</div>
{{end}}

</body>
</html>
